<!DOCTYPE html>
<html>

<head>
    <title>Document List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item border hover">
                        <a class="nav-link active" aria-current="page" href="GroupChat.html">Group chat</a>
                    </li>
                    <li class="nav-item border">
                        <a class="nav-link active" href="../Users/UserList.html">Manage Users</a>
                    </li>
                    <li class="nav-item border">
                        <a class="nav-link active" href="../Users/DocumentList.html">Manage Documents</a>
                    </li>
                    <li class="nav-item border">
                        <a class="nav-link active" href="../WelcomePage.html">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h5 class="card-title">Upload New Document</h5>
        <form id="uploadForm">
            <div class="mb-3 col-7">
                <label class="form-label">Document Label:</label>
                <input type="text" class="form-control" id="documentLabel" required />
            </div>
            <div class="mb-3 col-7">
                <label class="form-label">Select File:</label>
                <input type="file" class="form-control" id="documentFile" required />
            </div>
            <button type="submit" class="btn btn-success">Upload Document</button>
        </form>

        <h1 class="text-center mb-4">Document List</h1>
        <table class="table table-bordered table-striped table-dark table-hover" id="docTable">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>Filename</th>
                    <th>Uploaded Date</th>
                    <th>Uploaded By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="docTableBody"></tbody>
        </table>

        <script>
            const currentUser = JSON.parse(localStorage.getItem("currentUser")) || {
                id: null,
            };

            let uploads = JSON.parse(localStorage.getItem("uploads")) || [];

            document
                .getElementById("uploadForm")
                .addEventListener("submit", function (e) {
                    e.preventDefault();

                    const label = document.getElementById("documentLabel").value;
                    const fileInput = document.getElementById("documentFile");
                    const file = fileInput.files[0];

                    if (!label || !file) {
                        alert("Please fill all fields");
                        return;
                    }

                    const newDocument = {
                        id: uploads.length + 1,
                        label: label,
                        filename: file.name,
                        userId: currentUser.id,
                        uploadDate: new Date().toLocaleDateString(),
                        uploadedBy: currentUser.fullname || "Unknown User",
                    };

                    uploads.push(newDocument);
                    localStorage.setItem("uploads", JSON.stringify(uploads));
                    this.reset();
                    renderDocuments();
                });

            function renderDocuments() {
                const tbody = document.getElementById("docTableBody");
                tbody.innerHTML = "";

                uploads.forEach((doc) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${doc.label}</td>
                        <td>${doc.filename}</td>
                        <td>${doc.uploadDate}</td>
                        <td>${doc.uploadedBy}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="if(confirm('Are you sure you want to delete this document?')) deleteDocument(${doc.id})">
                                Delete
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editDocument(${doc.id})">
                                Edit
                            </button>
                            <button class="btn btn-success btn-sm" onclick="shareDocument(${doc.id})">
                                Share
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            window.deleteDocument = function (id) {
                uploads = uploads.filter((doc) => doc.id !== id);
                localStorage.setItem("uploads", JSON.stringify(uploads));
                renderDocuments();
            };
            window.editDocument = function (id) {
                const doc = uploads.find(d => d.id === id);
                const newLabel = prompt('Enter new label:', doc.label);
                const newFilename = prompt('Enter new filename:', doc.filename);
                const uploadedBy = prompt('Enter new uploader name:', doc.uploadedBy);
                if (!newLabel || !newFilename || !uploadedBy) {
                    alert('Please fill all fields');
                    return;
                }
                if (newLabel !== doc.label || newFilename !== doc.filename || uploadedBy !== doc.uploadedBy) {
                    doc.label = newLabel;
                    doc.filename = newFilename;
                    doc.uploadedBy = uploadedBy;
                    localStorage.setItem('uploads', JSON.stringify(uploads));
                    renderDocuments();
                }
                else if (newLabel === doc.label && newFilename === doc.filename && uploadedBy === doc.uploadedBy) {
                    alert('No changes made');
                }
            }

            window.shareDocument = function (id) {
                alert('Sharing functionality for document ID: ' + id);
            }

            renderDocuments();
        </script>
    </div>

    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Share Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Users:</label>
                        <div id="userList" class="list-group">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="confirmShare()">Share</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <h2 class="text-center mb-4">Shared Documents</h2>
        <table class="table table-bordered table-striped table-dark table-hover">
            <thead>
                <tr>
                    <th>Document</th>
                    <th>Owner</th>
                    <th>Shared With</th>
                    <th>Shared By</th>
                </tr>
            </thead>
            <tbody id="sharedListBody">
            </tbody>
        </table>
    </div>

    <script>
        let sharedList = JSON.parse(localStorage.getItem('sharedList')) || [];
        const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));

        window.shareDocument = function (docId) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const doc = uploads.find(d => d.id === docId);

            const userList = document.getElementById('userList');
            userList.innerHTML = users.filter(u => u.id !== currentUser.id).map(user => `
        <label class="list-group-item">
            <input class="form-check-input me-1" type="checkbox" value="${user.id}">
            ${user.fullname} (${user.email})
        </label>
    `).join('');

            document.getElementById('shareModal').dataset.docId = docId;
            shareModal.show();
        }

        window.confirmShare = function () {
            const docId = document.getElementById('shareModal').dataset.docId;
            const checkboxes = document.querySelectorAll('#userList input:checked');
            const doc = uploads.find(d => d.id === Number(docId));

            Array.from(checkboxes).forEach(checkbox => {
                const shareEntry = {
                    docId: doc.id,
                    docName: doc.label,
                    ownerId: doc.userId,
                    ownerName: doc.uploadedBy,
                    sharedWithId: checkbox.value,
                    sharedWithName: checkbox.parentElement.textContent.trim(),
                    sharedBy: currentUser.fullname,
                    sharedDate: new Date().toLocaleString()
                };

                if (!sharedList.some(entry =>
                    entry.docId === doc.id &&
                    entry.sharedWithId === checkbox.value
                )) {
                    sharedList.push(shareEntry);
                }
            });

            localStorage.setItem('sharedList', JSON.stringify(sharedList));
            shareModal.hide();
            alert('Document shared successfully!');
            renderSharedList();
            renderDocuments();
        }

        function renderSharedList() {
            const tbody = document.getElementById('sharedListBody');
            tbody.innerHTML = sharedList.map(entry => `
        <tr>
            <td>${entry.docName}</td>
            <td>${entry.ownerName}</td>
            <td>${entry.sharedWithName}</td>
            <td>${entry.sharedBy}</td>
        </tr>
    `).join('');
        }

        window.deleteDocument = function (id) {
            uploads = uploads.filter(doc => doc.id !== id);
            sharedList = sharedList.filter(entry => entry.docId !== id);
            localStorage.setItem('uploads', JSON.stringify(uploads));
            localStorage.setItem('sharedList', JSON.stringify(sharedList));
            renderDocuments();
            renderSharedList();
        }

        function renderDocuments() {
            const tbody = document.getElementById("docTableBody");
            tbody.innerHTML = "";

            uploads.forEach((doc) => {
                const shareCount = sharedList.filter(entry => entry.docId === doc.id).length;

                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${doc.label}</td>
            <td>${doc.filename}</td>
            <td>${doc.uploadDate}</td>
            <td>${doc.uploadedBy}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="if(confirm('Are you sure?')) deleteDocument(${doc.id})">
                    Delete
                </button>
                <button class="btn btn-primary btn-sm" onclick="editDocument(${doc.id})">
                    Edit
                </button>
                <button class="btn btn-success btn-sm" onclick="shareDocument(${doc.id})">
                    Share
                </button>
                <span class="badge bg-secondary ms-2">${shareCount} shared</span>
            </td>
        `;
                tbody.appendChild(row);
            });
        }
        setInterval(() => {
            messages = JSON.parse(localStorage.getItem('sharedListBody')) || [];
            renderSharedList();
            renderDocuments()
        }, 2000);
        renderDocuments();
        renderSharedList();
    </script>

</body>

</html>